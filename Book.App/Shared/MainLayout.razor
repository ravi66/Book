@inherits LayoutComponentBase
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="@isDarkMode" Theme="bookTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <BookAppBar />
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-1" >
            <MudScrollToTop>
                <MudFab StartIcon="@Icons.Material.Filled.ArrowCircleUp" />
            </MudScrollToTop>
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code
{
    [Inject] internal IBookSettingSvc BookSettingSvc { get; set; } = default!;

    [Inject] public IBookDbMigratorSvc DbMigrator { get; set; } = default!;

    [Inject] public INotifierSvc NotifierSvc { get; set; } = default!;

    MudTheme bookTheme = new MudTheme()
        {
            LayoutProperties = new LayoutProperties()
            {
                AppbarHeight = "48px"
            }
        };

    bool isDarkMode = true;

    protected async override Task OnInitializedAsync()
    {
        await DbMigrator.EnsureDbCreated();

        isDarkMode = await BookSettingSvc.GetDarkMode();

        NotifierSvc.ThemeChanged += ThemeChanged;
    }

    void ThemeChanged(object? sender, bool darkMode)
    {
        isDarkMode = darkMode;
        StateHasChanged();
    }

    public void Dispose()
    {
        NotifierSvc.ThemeChanged -= ThemeChanged;
        GC.SuppressFinalize(this);
    }
}